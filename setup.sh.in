#!/bin/bash
# check Root environment setup. Allow for external setup script.

# Update here when tagged
VERSION="v1.0.1"

#Set variables during build
INSTALL_DIR=@CMAKE_INSTALL_PREFIX@
LIB_DIR=@CMAKE_INSTALL_LIBDIR@
PYTHON_DIR=@CMAKE_INSTALL_PYTHON@
SOURCE_DIR=@PROJECT_SOURCE_DIR@
#ROOT_INCL=

# check Root environment setup
if [ -z "$(root-config --libs)" ] && [ -z "$(root-config --libs)"] && [ ! "$ROOTSYS" ]; then
  echo "Warning: No valid Root environment (ROOTSYS) defined. Please do so first!"
  return
fi

function validate_ROOT_release {
  # Ensure valid version of ROOT accessible
  # Can't assume that bc is installed
  # SC2155: Declare and assign separately to avoid masking return values.
  local ROOT_version_minimum
  local ROOT_version_minimum_major
  local ROOT_version_minimum_minor
  local ROOT_version
  local ROOT_version_major
  local ROOT_version_minor
  local compatible_ROOT_version

  ROOT_version_minimum="6.20"
  ROOT_version_minimum_major="$(echo $ROOT_version_minimum | cut -d "." -f 1)"
  ROOT_version_minimum_minor="$(echo $ROOT_version_minimum | cut -d "." -f 2)"
  ROOT_version="$(root-config --version)"
  ROOT_version_major="$(echo "$ROOT_version" | cut -d "." -f 1)"
  ROOT_version_minor="$(echo "$ROOT_version" | cut -d "." -f 2 | cut -d "/" -f 1)"
  compatible_ROOT_version=true

  if [[ "$ROOT_version_major" -lt "$ROOT_version_minimum_major" ]]; then
    compatible_ROOT_version=false
  elif [ "$ROOT_version_major" -eq "$ROOT_version_minimum_major" ] && [ "$ROOT_version_minor" -lt "$ROOT_version_minimum_minor" ]; then
    compatible_ROOT_version=false
  fi
  if [[ "$compatible_ROOT_version" = false ]]; then
      echo "ERROR: Version of ROOT detected: v$ROOT_version"
      echo "       ROOT v$ROOT_version_minimum+ is required to use HistFitter."
      return 1
  fi
}

validate_ROOT_release

#Check LD_LIBRARY_PATH
if [ ! "$LD_LIBRARY_PATH" ]; then
  echo "Warning: so far you haven't setup your ROOT enviroment properly (no LD_LIBRARY_PATH)"
  return
fi

#Export version number
HISTFITTER_VERSION=$VERSION
export HISTFITTER_VERSION

# update paths
export ROOT_INCLUDE_PATH="$ROOT_INCLUDE_PATH:$SOURCE_DIR/src" #What does this do?
export PATH="$PATH:$SOURCE_DIR/bin:$SOURCE_DIR/scripts"
export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$LIB_DIR"
# PYTHONPATH contains all directories that are used for 'import bla' commands
# Must prepend so as to catch python/cmdLineUtils.py before ROOT installation's
export PYTHONPATH="$PYTHON_DIR:$PYTHONPATH"
export PYTHONPATH="$SOURCE_DIR/scripts:$PYTHONPATH"

# Hack for ssh from mac
export LC_ALL=C
